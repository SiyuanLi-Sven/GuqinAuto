# 产品需求文档（PRD）v0.1：简谱→古琴减字谱自动编配与双谱面编辑器

## 1. 背景与问题定义

本产品要解决的核心问题是：用户提供“干净的简谱数据结构”（不做 OCR、不做 PDF/图片识别），系统自动生成一份可演奏的古琴减字谱，并以“简谱 + 减字谱”的双谱面形式呈现，允许用户交互式修改，系统随修改同步更新底层数据与试听音频。

之所以需要“双谱面本位”，是因为减字谱本质是指法/技法谱（怎么弹），传统减字谱对节奏信息并不天然完备；而简谱（数字谱）更适合作为节奏/时值的锚点。类似地，MusicXML 的 tablature（类指法谱）教程也明确指出 tablature 更直接指示弦与品位，往往“以牺牲精确节奏信息为代价”，但在 MusicXML 中节奏信息仍需被明确编码（即使显示时隐藏）。([W3C GitHub][1])

## 2. 产品定位与设计原则

产品定位为“古琴编配与教学辅助工具”，面向“从简谱生成可弹减字谱”的工作流，强调“自动化 + 可控 + 可编辑 + 可回放验证”。

设计原则以一条主线贯穿：用户交互层面以“简谱+减字谱的统一对象”为本位；系统实现层面以一个可交换、可归档、可渲染的谱面标准作为单一真源。MusicXML 本身就是为“数字化乐谱交换与归档”设计的开放标准。([W3C][2]) 同时 MusicXML 的 clef-sign 明确包含 `jianpu` 值，用来表示后续内容应以简谱（数字谱）方式呈现。([W3C][3])

## 3. 核心数据“单一真源”方案

建议把后端的“单一真源”定为 MusicXML（或后端自有 IR，再稳定编译为 MusicXML），原因是它同时能承载节奏/结构，又允许扩展承载古琴专属指法/技法信息。

实现上建议采用“一个 note-id 对应一个音乐事件对象”的建模：同一颗音在“综合双谱面视图”的简谱层与减字层共享身份（note-id 不变），从而做到“改简谱字段或改减字字段，都是在改同一对象的不同属性”。

古琴专属字段落位方式建议采用 MusicXML 的扩展槽位：`<other-technical>` 用于尚未被 MusicXML 标准覆盖的技术标记，并支持 `smufl` 属性以便用特定 glyph 提升互通性；([W3C][4]) `<other-notation>` 用于更通用的尚未覆盖记号。([W3C][5])

## 4. 页面与功能总览

下表定义 MVP 阶段必须具备的页面、目的与关键交互。

| 页面            | 页面目标                | 核心模块                                       | 关键交互与规则                                                                      |
| ------------- | ------------------- | ------------------------------------------ | ---------------------------------------------------------------------------- |
| 4.1 首页 / 项目列表 | 让用户创建、继续、管理工程       | 项目卡片、最近打开、导入入口                             | 新建项目进入“导入/参数”页；选择项目进入编辑器；项目展示最后修改时间与当前定弦方案                                   |
| 4.2 导入与参数页    | 接收“干净简谱数据结构”，设定生成约束 | 简谱上传（JSON/自定义结构）、调性/拍号/速度、古琴定弦/调弦、风格偏好（可选） | 上传后即刻进行校验（字段完整性、时值合法性、调性可解析）；参数变更触发“重新生成候选方案”但不丢用户已锁定的指法                     |
| 4.3 编辑器（核心）   | 双谱面呈现、交互修改、即时回放验证   | 综合双谱面视图（每行：上简谱+下减字谱）、音符选中与属性面板、候选方案对比、播放控制、版本/撤销  | 点击任意音符会在“同一行”的简谱层与减字层联动高亮同一 note-id；用户可在属性面板锁定某些字段，系统对剩余字段重跑优化器；支持 top-K 方案切换并比较差异 |
| 4.4 导出与分享（编辑器内） | 导出可用的“谱面+回放”产物      | 导出 MusicXML / MXL、导出 MIDI、导出音频、导出减字谱版式（后续） | 导出入口在编辑器内（不单独暴露 `/export` 页面/路由）；导出以 MusicXML 为源；MIDI与音频作为派生物一键生成；导出时记录版本号与参数快照 |
| 4.5 设置（可后置）   | 配置默认定弦、音源映射、渲染质量    | 默认参数、音源选择、播放延迟/缓存策略                        | 与编辑器播放链路联动：选择不同音源映射会触发“重新渲染音频缓存”                                             |

## 5. 编辑器页面（核心）交互细节

编辑器需要同时满足“用户心智本位”与“工程一致性”。**可视布局以“综合双谱面视图”为准：每一行（system）固定为“上方简谱（节奏锚点）+ 下方减字谱（动作锚点）”。**原因是：单独减字谱缺少节奏锚点，单独简谱缺少指法锚点；对用户而言两者必须始终并列出现，且共享同一组 note-id。

默认视觉风格：浅色背景、深色文字（便于长时间精读谱面与字段）。

交互上以“点选音符 → 右侧属性面板编辑”的范式为主，而不是要求用户在谱面上进行复杂的拖拽式编辑。前端谱面渲染建议基于 OpenSheetMusicDisplay（OSMD），其定位就是在浏览器中渲染 MusicXML。([GitHub][6])（OSMD 本体并不自带播放，需要你把播放链路另行实现或结合其他组件。）([GitHub][6])

属性面板对同一颗音呈现两组字段：
简谱字段包括：度数（1–7）、升降记号、八度点位、时值、连音/附点、强弱（可选）、小节位置。
减字谱字段包括：弦号、散/按/泛类别、徽位（或按音位置）、右手指法标签、左手技法标签、滑音/吟猱等连续参数（可选）、可演奏性提示（系统生成）、锁定开关。

当用户改动简谱字段时，系统需要保证节奏结构一致并更新音高，从而导致候选指法集变化；当用户改动减字谱字段时，系统把该音的指法/技法作为硬约束写回单一真源，再对邻域或全曲进行“约束下的再优化”。这满足“人类可控”的编辑体验，同时保持整体最优的自动补全能力。

候选方案对比建议提供“当前方案 + 备选 K-1 方案”的切换视图；切换时双谱面同时更新，但 note-id 不变，便于用户快速比较“更少换把/更偏泛音/更连贯音色”等差异。

## 6. 优化器（自动编配）在产品层的呈现方式

由于“简谱→减字谱”不是唯一映射，产品层面要让用户自然理解“系统是在做选择”。建议把优化器输出包装成“候选路径与理由”，而不是只给一个答案。

产品交互建议分两级：
第一级是确定性可解释的“规则与代价函数”结果，保证每次相同输入与参数能得到稳定输出（便于用户信任与复现）。
第二级是“风格化选择与微调建议”，可以由 LLM 对 top-K 结果进行排序与解释，但不直接从零生成减字谱；LLM 的角色是“择优与解释”，避免不可控的发散输出。

## 7. 播放与“声音链路”的产品要求

产品必须明确区分：MIDI 是“音符与控制数据”，不是音频；要发声必须通过音源/插件/合成器渲染。([image-line.com][7]) 因此编辑器的试听模块需要把“谱面变更”驱动到“可听见”的产物，建议采用三段式产物与优先级：
谱面刷新（MusicXML 渲染）优先级最高，保证用户改完立刻看见。
MIDI 更新作为中间产物，便于后续换音源与调试控制信息。
音频渲染是最终试听产物，允许做缓存与增量更新（例如只重渲受影响小节），但对用户呈现应保持“修改→很快可试听”的体验目标。

## 8. MVP 范围与非目标

MVP 明确不做 OCR、不做 PDF/图片导入；输入只接受“干净结构化简谱数据”或未来可选的标准化谱面文件（例如 MusicXML）。
MVP 优先支持单旋律线（单声部）与常见节拍；多声部、复杂装饰、自由节奏、古琴流派特定记谱差异先作为扩展项。

## 9. 成功指标（产品层）

建议用以下指标衡量 MVP 是否可用：从简谱导入到生成可弹方案的成功率、用户在编辑器中平均需要手改的音符比例、用户锁定若干音符后系统补全的成功率、用户一次导入后完成导出的比例、试听触发到可播放的稳定性。

---

[1]: https://w3c.github.io/musicxml/tutorial/tablature/?utm_source=chatgpt.com "Tablature | MusicXML 4.1 Draft - W3C on GitHub"
[2]: https://www.w3.org/2021/06/musicxml40/?utm_source=chatgpt.com "MusicXML 4.0"
[3]: https://www.w3.org/2021/06/musicxml40/musicxml-reference/data-types/clef-sign/?utm_source=chatgpt.com "clef-sign data type | MusicXML 4.0"
[4]: https://www.w3.org/2021/06/musicxml40/musicxml-reference/elements/other-technical/?utm_source=chatgpt.com "The <other-technical> element | MusicXML 4.0"
[5]: https://www.w3.org/2021/06/musicxml40/musicxml-reference/elements/other-notation/?utm_source=chatgpt.com "The <other-notation> element | MusicXML 4.0"
[6]: https://github.com/opensheetmusicdisplay/opensheetmusicdisplay?utm_source=chatgpt.com "OpenSheetMusicDisplay renders sheet music in MusicXML ..."
[7]: https://www.image-line.com/fl-studio-learning/fl-studio-online-manual/html/automation_midiimport.htm?utm_source=chatgpt.com "MIDI Import tool"
