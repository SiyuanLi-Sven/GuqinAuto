# 后端编辑协议（workspace + revision + delta）

本文档定义前端（Next.js, `:7137`）与后端（FastAPI, `:7130`）之间的**最小可用编辑协议**，用于把“综合双谱面视图”的交互编辑可靠地落到 MusicXML 真源上。

> 原则：学术级要求，宁可失败也不做静默降级。任何字段不一致/校验不通过必须明确报错。

stage1/stage2（候选音位枚举 + 指法序列优化）的 API 草案见：
- `docs/后端-API草案-stage1-stage2.md`

---

## 1. 真源与事件身份

- 真源：单个 MusicXML（`score-partwise 4.1`），双 staff：
  - staff 1：简谱层（节奏锚点）
  - staff 2：减字谱层（动作/指法锚点）
- 事件级身份：`eid`（全曲唯一，推荐 `E000001` 形式）
- 对齐：staff 1 的事件序列定义时间线；staff 2 必须 1:1 镜像（同一 `eid`、同一时值）。

详细 Profile 见：
- `docs/data/GuqinJZP-MusicXML Profile v0.2.md`

---

## 2. workspace（文件夹）与版本模型

后端使用 `backend/workspace/` 做项目级存储（未来可迁移到 sqlite，但文件结构保持可迁移性）。

约定：

```
backend/workspace/{project_id}/
  project.json
  revisions/
    R000001.musicxml
    R000002.musicxml
    ...
  deltas/
    D000001.json
    D000002.json
    ...
```

- `revision`：完整 MusicXML 快照（不可变）
- `delta`：一次编辑提交（操作列表 + message），用于审计/回放/未来的三方合并
- 并发：前端提交必须带 `base_revision`；如果与 `current_revision` 不一致，后端返回 `409` 冲突（不做自动合并）

---

## 3. 启动后端

仓库暂未做 Python 包安装，启动脚本会自动把 `backend/src` 加到 `PYTHONPATH`：

```bash
python backend/run_server.py --reload
```

默认监听：`http://127.0.0.1:7130`

---

## 4. API（v0：MVP 链路）

### 4.1 健康检查

- `GET /health`

返回：

```json
{"status":"ok"}
```

### 4.2 项目列表 / 创建项目

- `GET /projects`
- `POST /projects`

`POST /projects` 请求体：

```json
{
  "name": "demo",
  "example_filename": "guqin_jzp_profile_v0.2_showcase.musicxml",
  "tuning": null
}
```

返回 `ProjectMeta`：

```json
{
  "project_id": "Pxxxxxxxxxxxxxxxx",
  "name": "demo",
  "created_at": "2025-12-26T00:00:00+00:00",
  "current_revision": "R000001",
  "tuning": {
    "name": "demo_g_a_c_d_e_g_a",
    "open_pitches_midi": [55,57,60,62,64,67,69],
    "transpose_semitones": 0
  }
}
```

### 4.3 读取 MusicXML / 事件级 score 视图

- `GET /projects/{project_id}/musicxml`
- `GET /projects/{project_id}/score`
- `GET /projects/{project_id}/status`

`/score` 返回 `ProjectScoreView`（用于前端渲染与 Inspector 编辑）：

- `measures[].events[]`：按小节组织的事件流
- 每个 event 至少包含：
  - `eid`：事件身份（前端选中联动的 key）
  - `duration`：时值（当前以 staff 1/2 的 `<duration>` 作为一致性校验）
  - `staff1_notes`：staff 1 的单音/和弦信息（含 `slot`，用于撮/多弦与 `GuqinLink.slot` 对齐；并包含 `is_rest` 用于区分休止符事件）
  - `staff2_kv`：`GuqinJZP@0.2`/`GuqinJZP@0.3` 的结构化真值（dict）
  - `jzp_text`：由 `staff2_kv` 可重复生成的派生显示层（缓存/渲染输入）
  - `jianpu_text`：简谱显示（当前从 staff1 lyric@above 读取；后续可扩展）

`/status` 返回项目就绪性诊断（例如 pitch-resolved 是否满足），用于前端阻塞 stage1/stage2 并提示原因：

- `pitch_issues[]`：阻塞型问题（例如 staff1 的非休止符事件缺少绝对 pitch）
- `consistency_warnings[]`：提示型一致性问题（允许继续编辑，但 UI 必须提示；例如 staff1 pitch 与 staff2 指法真值推导不一致，或 v0.3 真值缺失导致不可检查）

### 4.4 应用编辑（生成新 revision + delta）

- `POST /projects/{project_id}/apply`
- `POST /projects/{project_id}/resolve_pitch`

请求体：

```json
{
  "base_revision": "R000001",
  "message": "把 E010001 改成 抹三",
  "ops": [
    {
      "op": "update_guqin_event",
      "eid": "E010001",
      "changes": {
        "form": "simple",
        "xian_finger": "抹",
        "xian": "3"
      }
    }
  ]
}
```

返回：

- `project`：更新后的 `ProjectMeta`（`current_revision` 前进）
- `score`：新 revision 的 `ProjectScoreView`（便于前端直接刷新局部/全局）

错误约定：

- `409`：`base_revision` 与当前 revision 不一致（并发冲突，不做自动合并）
- `400`：操作非法或校验失败（例如 token 不在规范内、结构化字段不足以生成可解析的 `jzp_text`）

`/resolve_pitch` 用于把绝对 pitch 编译落地写入 staff1（pitch-resolved gate）。该端点要求调用方明确提供 `step/alter/octave`，不允许猜测 enharmonic；写回后会生成新 revision。

---

## 5. 编辑操作（当前支持范围）

### 5.1 `update_guqin_event`（MVP 仅支持 staff 2 的结构化指法）

语义：
- 定位到 `eid` 对应的 staff 2 `<note>`（要求其 `<other-technical>` 为 `GuqinJZP@0.2;...`）
- 把 `changes` 里的 key/value 合并进 `GuqinJZP@0.2`/`GuqinJZP@0.3` KV（保持原版本号不变）
- 重新渲染 `jzp_text` 并做“可解析性校验”
- 写回：
  - `<other-technical>`：更新 KV 串
  - `lyric@below`：更新 `jzp_text`（显示缓存）

强约束：
- 不允许修改 `eid`（事件身份稳定）
- 渲染或解析校验失败必须报错（不允许“尽量生成个能显示的文本”）

---

## 6. 下一步（即将扩展的 op 类型）

为了支持真正的编辑器体验，后续 op 需要覆盖：

- staff 1 的节奏/音高编辑（并同步 staff 2 时值，保持对齐）
- chord（撮/和弦）结构编辑（slot 的维护）
- 插入/删除事件（必须维护全曲 `eid` 唯一性与双 staff 对齐）
- 撤销/重做：前端可基于 `delta` 序列或保存的 revision 栈实现

这些扩展会优先保持“协议可演进”，避免一次性设计过度复杂。
