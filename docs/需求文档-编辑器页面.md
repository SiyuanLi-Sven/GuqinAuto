整体设计的核心类比是：像 Sibelius 的 *Dynamic Guitar Staves* 那样，把“同一条音乐数据流”同时投影成“记谱视图 + 指法谱视图”，两边联动、但允许各自选择性显示信息以避免画面拥挤。([scoringnotes.com][1])

---

# 1. 编辑器页面的“本位”与渲染底座

## 1.1 用户本位

用户看到并编辑的是一个“简谱 + 减字谱”的统一对象：
简谱负责把节奏（时值、连音、附点、拍号小节）钉死；减字谱负责把动作（弦序、徽位、散/按/泛、左右手技法、滑音/吟猱参数）钉死。用户对任意一边的修改，都应当被视为在修改“同一颗音”。

## 1.2 系统真源（轻提数据结构）

后台建议以 **MusicXML** 作为单一真源（或 IR→稳定编译为 MusicXML）。理由是：
一方面 MusicXML 明确支持“简谱模式”的 clef-sign：`jianpu`，语义就是“后续音乐应以简谱编号记谱呈现”。([w3.org][2])
另一方面，古琴专属指法/技法可以放到 MusicXML 的扩展槽位：`<other-technical>`、`<other-notation>`，并可用 `smufl` 指定 glyph 名来提升互通性。([w3.org][3])

前端渲染建议基于 **OpenSheetMusicDisplay（OSMD）**，它是“在浏览器里显示 MusicXML 的渲染器”，底层用 VexFlow。([Open Sheet Music Display][4]) 但要注意：OSMD 官方明确说它是 renderer，不是交互式编辑器，不能指望像打谱软件那样直接拖动/插入音符。([GitHub][5])
所以交互设计要走“谱面可点击 + 右侧属性面板编辑 + 后台重绘”的范式（并辅以局部高亮/变色这类轻量即时反馈）。([GitHub][5])

---

# 2. 页面布局

编辑器建议分为 5 个稳定区域（全程不跳出页面即可完成工作）：

A. 顶部工具栏：项目名、保存状态、撤销/重做、导出、播放控制（播放/暂停、节拍器、循环段、速度滑条）。
B. 左侧“结构栏”：曲目结构（段落/小节导航）、方案管理（当前方案、Top-K 备选）、锁定统计（已锁定多少音/小节）。
C. 中央“谱面区”：**综合双谱面视图**（不可拆分）。每一行（system）固定为“上方简谱（节奏锚）+ 下方减字谱（动作锚）”，并以同一 note-id 贯穿联动；支持同步滚动与同步光标。
D. 右侧“属性面板（Inspector）”：点选音符后出现，分“简谱属性 / 减字属性 / 候选与诊断 / 回放表现”四个页签。
E. 底部“事件条（可选但强烈建议）”：以时间线方式显示“滑音/吟猱曲线、技法切换、力度/音色控制”等，便于做试听层调参（尤其当你要把减字谱映射到 MIDI 控制时）。

---

# 3. 核心交互：选中与联动

## 3.1 选中规则

用户在综合双谱面视图中点击一个音符，系统要做 4 件事：
第一，在同一行（system）的“简谱层 + 减字层”同时高亮同一 note-id。
第二，右侧 Inspector 打开并定位到该音符。
第三，显示“该音符的候选指法集”以及当前选择为何。
第四，如果当前音符存在“可演奏性风险/冲突”，以不打扰的方式标记（例如橙色角标），并把原因写进 Inspector 的“诊断”页。

## 3.2 范围选择（处理真实编辑需求）

必须支持三种选择：单音、连续片段（拖选或 Shift+点击）、整小节。因为用户常见的编辑不是改一个音，而是“这两小节都想更少换把”“这句想多用泛音音色”。

范围选择后，Inspector 的行为变为“批量编辑”：
简谱侧可批量改时值类型（例如把一串八分改成三连音）、批量加连线；减字侧可批量施加偏好/约束（如“这一句尽量在 3~7 徽范围”“优先用 1/2 弦”“避免散音”）。

---

# 4. Inspector 设计（用户真正会操作的地方）

Inspector 不要堆成一页，建议四个页签，且每个页签只做一类决定。

## 4.1 简谱属性（节奏与音高语义）

对单音的关键字段：度数（1–7）、临时升降、八度点、时值（分音符类型）、附点、连音线、休止替换。
对范围的关键操作：节奏量化、连音/断音、分组（按拍内分组）、小节内重排（保持总时值不变的前提下做拆分/合并）。

这里的交互要强调“可逆”：每次修改都可撤销，并在修改时显示“对小节总时值是否仍平衡”的即时校验提示（不平衡就阻止提交或引导自动补足休止）。

## 4.2 减字属性（指法与技法语义）

对单音的关键字段：散/按/泛，弦号，徽位（或按音位置），右手指法标签，左手技法标签，滑音/吟猱参数（若存在），以及“锁定开关”。

“锁定开关”要做成细粒度的，而不是一个总锁：
用户可能只想锁定弦号，不锁徽位；或锁定“必须泛音”，但徽位可让系统挑。细粒度锁定是让系统“自动补全”仍然有空间的关键。

对范围的关键操作：施加偏好与硬约束。偏好例如“尽量少换弦”“优先某条弦/某徽区间”“偏泛音音色”；硬约束例如“此处必须走手滑音”“这几个音必须在同一弦上完成”。偏好不保证满足但会影响代价，硬约束不满足就不能产出方案。

## 4.3 候选与诊断（把‘非唯一映射’变得可理解）

这个页签解决用户最大的疑惑：“为什么系统给我这个指法？”
它要展示：当前音（或当前范围）的 Top-K 候选，按“总评分”排序，并能展开看到评分构成，例如“换把代价、跨弦代价、可弹性风险、音色一致性”。

同时提供一个“对比模式”：切换候选时，谱面区只做两类变化提示：
第一，变更的音符用颜色闪一下；第二，在左侧结构栏里显示“本次候选与当前方案差异：多少音改变、集中在哪些小节”。

诊断信息至少覆盖三类：
A 类错误（硬不可弹）：例如徽位超范围、技法组合逻辑不成立；
B 类风险（可弹但很反人类）：例如极短时值要求大滑音、连续大跳把位；
C 类风格偏离（可弹且合理但不符合偏好）：例如你设置“偏泛音”，但系统被其他约束逼到按音。

## 4.4 回放表现（把谱面语义映射到‘能听’）

这里不讨论底层接口，但产品上必须允许用户调：
滑音/吟猱强度、起止时间相对时值的百分比、装饰音是否抢拍、泛音音色强弱、衰减长度等。
原因是：同一份减字谱在不同音源/渲染器上听感差异大，用户需要一个“把试听调顺”的地方，而不是被迫改谱。

---

# 5. 修改后的“立即反馈”策略（让用户觉得顺）

因为 OSMD 是渲染器而不是编辑器，你要通过策略让用户仍然感到“即时”。([GitHub][5])

建议按优先级做三段式反馈：

第一段：视觉立即反馈（<100ms 级别）
用户一改字段，立刻在当前谱面上做轻量反馈：高亮、角标、提示文本变化；不等重排版。

第二段：谱面刷新反馈（几百 ms～1s 级别）
后台更新 MusicXML 后，触发 OSMD 重新渲染当前页/当前系统（分页渲染或只渲当前可视范围）。OSMD 官方也提到渲染需要时间，因此要尽量做局部与缓存策略。([GitHub][5])

第三段：试听反馈（可异步但要可感知）
MIDI/音频生成可能更慢，但用户必须看到“正在更新试听”的状态，并且允许先用“临时 MIDI 播放”顶上，再用高质量渲染替换（例如播放条上显示“草稿/高质量”标记）。

---

# 6. 方案管理（非常关键，否则用户会怕‘一改全乱’）

编辑器必须内置“方案”概念：
自动编配每次运行都产出一个方案（含全曲的减字选择与参数）；用户可以在左侧结构栏保存当前方案为“版本”，并随时回到旧版本。

建议提供两种安全机制：

机制 1：局部再优化
用户只改了第 12 小节，就只对“受影响窗口”再优化（例如 10–14 小节），其他小节不动；除非用户明确点击“全曲重算”。

机制 2：锁定保护
用户已锁定的音符/片段永不被自动改动；优化器只能在未锁定部分寻找最优路径。这个机制能让用户愿意大胆手工修关键处，再让系统补全其余。

---

# 7. 必须覆盖的“真实用户情况”（按场景设计）

为了避免产品上线后到处补洞，下面这些场景编辑器要能优雅处理：

场景 A：用户只给了旋律但没给调性（1=Do 不明确）
编辑器在导入后应当把“调性/主音”作为显著的顶部参数；不设定则只显示相对度数，不生成绝对音高相关的指法候选（或提示“先设定调性才能生成减字谱”）。

场景 B：用户改了节奏，导致原指法不再合理
系统应当保留用户锁定的部分，其余音符提示“原指法已不再满足可弹性/时值约束”，并给出一键“按当前锁定重算本句”。

场景 C：用户希望这一句“尽量不换把”，但系统觉得会更难听/更怪
这就是“偏好 vs 风险”的典型冲突：在“候选与诊断”里展示两套方案及理由，并允许用户一键选择“牺牲音色一致性换取少换把”，而不是系统偷偷替用户做价值判断。

场景 D：用户想对比两套风格（偏泛音 vs 偏按音）
方案管理里提供“风格预设”，一键复制当前方案为新方案并切换偏好参数；对比模式显示差异集中在哪些小节。

场景 E：用户只想改一个音的弦号，其余都别动
细粒度锁定 + 局部再优化即可覆盖：锁定该音的弦号字段，其它字段仍可被系统微调以保持连贯。

---

# 8. 一个你可以直接写进 PRD 的“编辑器承诺”

编辑器对用户的承诺可以写成一句话：
“你编辑的是‘简谱+减字谱的同一首音乐’，系统保证两种视图永远同步；自动编配只在你允许的范围内行动（锁定即保护），并且每一次自动改动都有可解释的候选与理由。”

---

[1]: https://www.scoringnotes.com/news/sibelius-2022-7/?utm_source=chatgpt.com "Guitar tab can be fun in the Sibelius 2022.7 update"
[2]: https://www.w3.org/2021/06/musicxml40/musicxml-reference/data-types/clef-sign/?utm_source=chatgpt.com "clef-sign data type | MusicXML 4.0"
[3]: https://www.w3.org/2021/06/musicxml40/musicxml-reference/elements/other-technical/?utm_source=chatgpt.com "The <other-technical> element | MusicXML 4.0"
[4]: https://opensheetmusicdisplay.org/?utm_source=chatgpt.com "Open Sheet Music Display: Home"
[5]: https://github.com/opensheetmusicdisplay/opensheetmusicdisplay?utm_source=chatgpt.com "OpenSheetMusicDisplay renders sheet music in MusicXML ..."
