# 后端：音高 ↔ 古琴指法映射模块（Pitch ↔ Fingering）

本文档把 GuqinAuto 的两个核心“可计算方向”写死，并明确它们如何被复用：

1) **简谱/音高 → 古琴指法候选（1→多）**：也就是我们之前说的 stage1  
2) **古琴指法 → 音高/简谱（1→1）**：在给定定弦/移调与真值字段齐全的前提下，应当是确定可计算的

同时，我们明确一个编辑器层面非常重要的产品选择：

- **允许前后不一致**：用户在编辑过程中，允许 staff1（简谱/pitch）与 staff2（减字谱指法真值）暂时不一致  
- **持续检查与提示**：后端持续用本模块做一致性检查，把不一致点作为 warning 返回给前端 UI（不阻塞编辑，但不允许静默忽略）
- **写回由用户显式触发（写死）**：系统可以“计算与建议”，但不得在用户未确认的情况下静默写回/修正 MusicXML 真源（避免静默改谱）
  - 允许“生成初稿”这类显式动作：导入简谱后一次性生成初步方案并写回（生成新 revision），后续再由用户逐单元调整

> 规范性语言：MUST / SHOULD / MAY

---

## 0. 前提：MusicXML 是唯一真源（写死）

本模块不会引入新的“第二真源”。所有推导、检查都以 MusicXML 真源为依据：

- staff1：节奏锚点（以及需要时的绝对 pitch）
- staff2：古琴指法真值（GuqinJZP@... 的结构化字段）

相关规范见：`docs/data/GuqinJZP-MusicXML Profile v0.2.md`

---

## 1. 方向 A：Pitch → Fingering candidates（stage1，1→多）

### 1.1 输入（MUST）

- 目标 pitch（绝对音高），来自 staff1 `<pitch>`（或“简谱度数 + 主音/调性”编译写回后得到的 `<pitch>`）
- 项目定弦 `tuning`（7 弦开弦 MIDI + transpose）
- 选项：temperament / 最大把位范围 / 是否包含泛音候选等

### 1.2 输出（MUST）

对每个事件（eid + slot），输出一组候选：

- 弦（string 1..7）
- technique（open/press/harmonic）
- pitch_midi（候选对应音高）
- 连续位置真值（未来 Profile v0.3：`pos_ratio`）
- 以及必要的来源信息（用于可解释性）

> 该方向的实现现阶段由后端 stage1 接口与 PositionEngine 承担。

实现位置：

- Pitch → Fingering（stage1 候选枚举）：`backend/src/guqinauto_backend/engines/position_engine.py`
- Fingering → Pitch（确定推导/用于一致性检查）：`backend/src/guqinauto_backend/domain/guqin_fingering_pitch.py`

---

## 1.3 “推荐”与“写回”的边界（写死）

我们区分三种层次的产物：

1) **候选（candidates）**：由 stage1 枚举，回答“有哪些弦/位置是可行的？”  
2) **建议（suggestion）**：系统基于规则或 stage2 代价函数，给出一个默认选择（便于 UI 先显示一版）  
3) **真值（truth）**：用户在 UI 中明确选择并确认后，才写回到 MusicXML staff2（`GuqinJZP@...`）

强约束（MUST）：

- stage1/stage2 只能产出 1) 与 2)
- 写回（把建议变成真值）必须由用户显式触发：
  - A) “生成初稿”动作：可把建议一次性写回为初步方案（生成新 revision）
  - B) “逐单元确认”动作：点击一个事件单元 → 选择候选 → 选择技法 → 确认写回

---

## 2. 方向 B：Fingering → Pitch（1→1，确定可计算）

### 2.1 设计目标（MUST）

给定：

- 项目定弦（7 弦开弦 pitch）
- 一个事件在 staff2 的“指法真值字段”

我们 MUST 能确定性地计算出该事件的“应当发声的 pitch”（或 chord 的多个 pitch），用于：

- 校验：staff1 与 staff2 是否一致
- 反向编译：从指法真值生成/修正 staff1 pitch（当用户明确触发“对齐/修复”时）
- 导出：MIDI/音频派生物的可复现生成（注意它们仍然是 export-only 的有损派生物）

### 2.2 必要真值（MUST）

仅靠 Profile v0.2 的 `hui/fen`，无法在不做假设的情况下“精确确定 pitch”：

- 徽位更像“物理位置标记”，不是音级；不同学派/律制与现实乐器都会有偏差
- 如果我们仅凭 `hui/fen` 硬算音高，本质上就是在做隐式假设与静默降级（违背“正确地失败”）

因此我们把“可逆的一对一计算”写死为 **Profile v0.3** 的必要能力（见 `docs/data/GuqinJZP-MusicXML Profile v0.2.md` 的 v0.3 方向）：

- `pos_ratio`：连续位置真值（0..1，表示有效弦长比例）
- `sound`：声源类别（open/pressed/harmonic）
- 对 harmonic：需要明确的节点信息（例如 `harmonic_n`/`harmonic_k` 或等价表达）

当这些真值齐全时，Fingering → Pitch MUST 是确定的。

> 现阶段（v0.2）：该方向只能做**部分检查**（例如“散音/开弦”可确定），其它情况 MUST 明确提示“无法判断，需要 v0.3 真值”，不允许猜测。

---

## 3. 编辑器的一致性策略（允许不一致，但持续提示）

### 3.1 状态定义（建议）

编辑器面向用户至少要区分三种状态：

1) `pitch_resolved=false`：staff1 缺少绝对 pitch（阻塞 stage1/stage2 与 MIDI/音频导出）
2) `pitch_resolved=true` 且 `consistency_warnings=[]`：可推荐/可导出，且简谱与指法一致（或至少可检查的部分一致）
3) `pitch_resolved=true` 但存在 `consistency_warnings`：允许继续编辑，但 UI 必须提示“哪里不一致/为什么无法判断”

### 3.2 后端输出（MUST）

后端 MUST 提供一个轻量接口给前端（当前落在 `/projects/{id}/status`）：

- `pitch_issues[]`：阻塞型问题（例如 staff1 pitch 未解析）
- `consistency_warnings[]`：提示型问题（不阻塞编辑）

其中 `consistency_warnings` 的原则是：

- 能判断 → 给出 `expected_pitch_midi` 与 `actual_pitch_midi`，并说明 reason
- 不能判断 → reason 必须明确指出缺少的真值（例如 “需要 v0.3 pos_ratio/sound”）

---

## 4. 显示层策略（先不做字形渲染）

我们明确一个务实取舍：**先用不损失含义的文本表示**来显示减字谱（例如 `散勾三`）。

- `jzp_text` 是“可重复生成的显示层”，由结构化真值字段生成
- 前端短期只需要可靠显示/可复制/可检索即可，不强依赖字体/SVG 字形渲染
- 未来如果要做精致字形渲染（字体或 SVG），应当作为显示层的可选升级，不改变真源与编辑协议

---

## 5. 交互流（写死的核心：用户确认后写回）

编辑器对单个事件单元（eid/slot）的推荐与确认流程建议如下：

1) 系统在当前 staff1 pitch + tuning 下运行 stage1，得到候选集合  
2) 系统可用规则或 stage2 给出一个“建议态”并显示在谱面上（但不写回）  
3) 用户点击该单元 → 弹出候选菜单（弦 + 位置/泛音节点）  
4) 用户选定“音位真值”（对应 v0.3：`sound + pos_ratio/(harmonic_n/k)`）  
5) 用户再选定“读法真值”（`form` 与 token，如 `xian_finger/hui_finger/...`）  
6) 用户点击确认 → 后端 `POST /apply` 写回 staff2 KV（生成新 revision）

建议写回元数据（SHOULD）：

- “生成初稿”写回时：`edit_source=auto`（写回 `truth_src=auto,user_touched=0`）
- 用户单元确认写回时：`edit_source=user`（写回 `truth_src=user,user_touched=1`）

## 6. 再次主动推荐：只更新未改过的单元（方向先记录）

系统应当支持“再次主动推荐”，用于用户修改一部分后，让系统把剩余未改部分补齐得更一致：

- 输入：当前谱面真源（staff1 pitch+节奏 + staff2 指法真值），以及 `tuning`
- 约束（写死）：
  - `user_touched=1` 的单元视为硬约束，不允许被覆盖
  - `user_touched=0` 的单元允许被重新推荐与写回
- 输出：新的“建议态”或新的“初稿 revision”（二选一；都必须是显式触发）

本能力当前仅记录为方向，尚未实现端到端闭环。
